#!/bin/bash
set -e

# ================= CONFIG =================
USER_NAME=$(whoami)
BASE_DIR="$(pwd)/hytale_server"
SERVER_DIR="$BASE_DIR/server"
DOWNLOADER_URL="https://downloader.hytale.com/hytale-downloader.zip"
SERVICE_FILE="/etc/systemd/system/hytale.service"
RESTART_CRON="0 0 */3 * * /usr/bin/systemctl restart hytale"
PORT=5520
# =========================================

uninstall_server() {
  echo ""
  echo -e "${BOLD}${YELLOW}=== Uninstalling Hytale Server ===${NC}"
  echo ""
  
  # Use default port if CUSTOM_PORT is not set
  UNINSTALL_PORT=${CUSTOM_PORT:-$PORT}
  
  # Stop and disable service
  if systemctl is-active --quiet hytale 2>/dev/null; then
    echo -e "${BLUE}Stopping Hytale service...${NC}"
    sudo systemctl stop hytale
  fi
  
  if systemctl is-enabled --quiet hytale 2>/dev/null; then
    echo -e "${BLUE}Disabling Hytale service...${NC}"
    sudo systemctl disable hytale
  fi
  
  # Remove service file
  if [ -f "$SERVICE_FILE" ]; then
    echo -e "${BLUE}Removing service file...${NC}"
    sudo rm -f "$SERVICE_FILE"
    sudo systemctl daemon-reload
  fi
  
  # Remove server files
  if [ -d "$BASE_DIR" ]; then
    echo -e "${BLUE}Removing server files from $BASE_DIR...${NC}"
    rm -rf "$BASE_DIR"
  fi
  
  # Remove firewall rule
  if command -v ufw >/dev/null 2>&1; then
    echo -e "${BLUE}Removing firewall rule...${NC}"
    sudo ufw delete allow ${UNINSTALL_PORT}/udp 2>/dev/null || true
  fi
  
  echo ""
  echo -e "${GREEN}==========================================${NC}"
  echo -e "${BOLD}${GREEN}Uninstall complete!${NC}"
  echo -e "${GREEN}==========================================${NC}"
}

update_server() {
  echo ""
  echo -e "${BOLD}${YELLOW}=== Updating Hytale Server ===${NC}"
  echo ""
  
  # Check if server is installed
  if ! systemctl list-unit-files | grep -q hytale.service; then
    echo -e "${RED}ERROR: Hytale server is not installed.${NC}"
    echo -e "${YELLOW}Please install it first using option 1.${NC}"
    exit 1
  fi
  
  echo -e "${CYAN}[1/5]${NC} Stopping Hytale service..."
  sudo systemctl stop hytale
  
  echo -e "${CYAN}[2/5]${NC} Downloading Hytale Downloader..."
  cd "$BASE_DIR" || { echo -e "${RED}Failed to change to $BASE_DIR.${NC}" >&2; exit 1; }
  
  if [ ! -f "hytale-downloader-linux-amd64" ]; then
    if wget --no-cookies --no-cache --show-progress -O hytale-downloader.zip "$DOWNLOADER_URL"; then
      if unzip -q hytale-downloader.zip; then
        chmod +x hytale-downloader-linux-amd64
        rm -f hytale-downloader-windows-amd64.exe hytale-downloader.zip
      fi
    fi
  fi
  
  echo -e "${CYAN}[3/5]${NC} Downloading latest server files..."
  if ./hytale-downloader-linux-amd64; then
    echo -e "${GREEN}Server files downloaded.${NC}"
  else
    echo -e "${RED}Failed to download server files.${NC}" >&2
    exit 1
  fi
  
  DOWNLOADED_ZIP=$(ls -t *.zip 2>/dev/null | head -1)
  
  if [ -z "$DOWNLOADED_ZIP" ]; then
    echo -e "${RED}No zip file found after download.${NC}" >&2
    exit 1
  fi
  
  echo -e "${CYAN}[4/5]${NC} Extracting and updating server files..."
  echo -e "${BLUE}Extracting files:${NC}"
  if unzip -o "$DOWNLOADED_ZIP" | grep -E "(inflating|extracting):" | sed "s/^/  ${CYAN}→${NC} /"; then
    echo -e "${GREEN}✓ Extraction complete.${NC}"
  else
    echo -e "${RED}Failed to extract server files.${NC}" >&2
    exit 1
  fi
  
  # Update server files
  if [ -d "Server" ]; then
    rm -rf "$SERVER_DIR"/*
    cp -r Server/* "$SERVER_DIR/" || { echo "Failed to copy server files." >&2; exit 1; }
  fi
  
  if [ -f "Assets.zip" ]; then
    cp "Assets.zip" "$SERVER_DIR/" || { echo "Failed to copy Assets.zip." >&2; exit 1; }
  fi
  
  # Clean up
  rm -f "$DOWNLOADED_ZIP"
  rm -rf Server
  rm -f Assets.zip
  rm -f QUICKSTART.md
  
  echo -e "${CYAN}[5/5]${NC} Starting Hytale service..."
  sudo systemctl start hytale
  
  echo ""
  echo -e "${GREEN}==========================================${NC}"
  echo -e "${BOLD}${GREEN}Update complete!${NC}"
  echo -e "${BLUE}Check logs with: ${NC}journalctl -u hytale -f"
  echo -e "${GREEN}==========================================${NC}"
}

install_server() {
  echo ""
  echo -e "${BOLD}${CYAN}=== Installing Hytale Dedicated Server ===${NC}"
  echo ""
  
  # Check if already installed
  if systemctl is-active --quiet hytale 2>/dev/null; then
    echo -e "${YELLOW}WARNING: Hytale service is already running!${NC}"
    echo -e "${YELLOW}Please uninstall first using option 3.${NC}"
    exit 1
  fi

  # Port configuration
  echo -e "${CYAN}Port Configuration${NC}"
  read -p "Enter server port (default: 5520): " CUSTOM_PORT
  
  if [ -z "$CUSTOM_PORT" ]; then
    CUSTOM_PORT=$PORT
    echo -e "${BLUE}Using default port: ${CUSTOM_PORT}${NC}"
  else
    # Validate port number
    if ! [[ "$CUSTOM_PORT" =~ ^[0-9]+$ ]] || [ "$CUSTOM_PORT" -lt 1024 ] || [ "$CUSTOM_PORT" -gt 65535 ]; then
      echo -e "${RED}Invalid port number. Must be between 1024 and 65535.${NC}"
      exit 1
    fi
    echo -e "${GREEN}Using custom port: ${CUSTOM_PORT}${NC}"
  fi
  echo ""

echo -e "${CYAN}[1/7]${NC} Checking dependencies..."

# Check and install unzip if missing
if ! command -v unzip >/dev/null 2>&1; then
  echo -e "${BLUE}Installing unzip...${NC}"
  sudo apt-get update -qq
  sudo apt-get install -y unzip
  echo -e "${GREEN}✓ unzip installed.${NC}"
else
  echo -e "${GREEN}✓ unzip is already installed.${NC}"
fi

# Check and install tmux if missing
if ! command -v tmux >/dev/null 2>&1; then
  echo -e "${BLUE}Installing tmux...${NC}"
  sudo apt-get install -y tmux
  echo -e "${GREEN}✓ tmux installed.${NC}"
else
  echo -e "${GREEN}✓ tmux is already installed.${NC}"
fi

echo -e "${BLUE}Checking Java installation...${NC}"
JAVA_VERSION_OUTPUT=$(java -version 2>&1 || true)
JAVA_VERSION=$(echo "$JAVA_VERSION_OUTPUT" | awk -F[\".] '/version/ {print $2}')

if [[ "$JAVA_VERSION_OUTPUT" == *"25."* || "$JAVA_VERSION" == "25" ]]; then
  echo -e "${GREEN}✓ Java 25 is already installed.${NC}"
else
  echo -e "${BLUE}Installing Java 25...${NC}"
  if wget --no-cookies --no-cache -q --show-progress https://download.oracle.com/java/25/latest/jdk-25_linux-x64_bin.deb; then
    if sudo dpkg -i jdk-25_linux-x64_bin.deb; then
      echo -e "${GREEN}✓ Java 25 installed successfully.${NC}"
      rm jdk-25_linux-x64_bin.deb
    else
      echo -e "${RED}Failed to install Java.${NC}" >&2
      exit 1
    fi
  else
    echo -e "${RED}Failed to download Java installer.${NC}" >&2
    exit 1
  fi
fi

java --version || { echo "Java not found in PATH." >&2; exit 1; }

# Check available disk space
echo -e "${BLUE}Checking available disk space...${NC}"
REQUIRED_SPACE_MB=5120  # 5 GB in MB
AVAILABLE_SPACE_MB=$(df -BM "$(pwd)" | awk 'NR==2 {print $4}' | sed 's/M//')

if [ "$AVAILABLE_SPACE_MB" -lt "$REQUIRED_SPACE_MB" ]; then
  echo -e "${RED}ERROR: Insufficient disk space.${NC}"
  echo -e "${YELLOW}Required: ${REQUIRED_SPACE_MB} MB (5 GB)${NC}"
  echo -e "${YELLOW}Available: ${AVAILABLE_SPACE_MB} MB${NC}"
  exit 1
else
  echo -e "${GREEN}✓ Sufficient disk space available (${AVAILABLE_SPACE_MB} MB).${NC}"
fi


# ---- 2. Create directories ----
echo -e "${CYAN}[2/7]${NC} Creating directories..."
mkdir -p "$SERVER_DIR"


# ---- 3. Install Hytale Downloader CLI ----
echo -e "${CYAN}[3/7]${NC} Downloading Hytale Downloader..."

if wget --no-cookies --no-cache --show-progress -O hytale-downloader.zip "$DOWNLOADER_URL"; then
  echo -e "${GREEN}Hytale Downloader downloaded.${NC}"
else
  echo -e "${RED}Failed to download Hytale Downloader.${NC}" >&2
  exit 1
fi
echo -e "${BLUE}Extracting Hytale Downloader...${NC}"
if unzip -q hytale-downloader.zip; then
  echo -e "${GREEN}✓ Extraction complete.${NC}"
else
  echo -e "${RED}Failed to extract Hytale Downloader.${NC}" >&2
  exit 1
fi

chmod +x hytale-downloader-linux-amd64
rm -f hytale-downloader-windows-amd64.exe hytale-downloader.zip

if [ "$(realpath QUICKSTART.md)" != "$BASE_DIR/QUICKSTART.md" ]; then
  mv QUICKSTART.md "$BASE_DIR/"
fi

if [ "$(realpath hytale-downloader-linux-amd64)" != "$BASE_DIR/hytale-downloader-linux-amd64" ]; then
  mv hytale-downloader-linux-amd64 "$BASE_DIR/"
fi


# ---- 4. Download server files ----
echo -e "${CYAN}[4/7]${NC} Downloading Hytale server files..."
cd "$BASE_DIR" || { echo -e "${RED}Failed to change to $BASE_DIR.${NC}" >&2; exit 1; }
if ./hytale-downloader-linux-amd64; then
  echo -e "${GREEN}Server files downloaded.${NC}"
else
  echo -e "${RED}Failed to download server files.${NC}" >&2
  exit 1
fi

# Expected structure: The downloader creates a zip file like "2026.01.15-c04fdfe10.zip"
# Find the most recently created zip file
DOWNLOADED_ZIP=$(ls -t *.zip 2>/dev/null | head -1)

if [ -z "$DOWNLOADED_ZIP" ]; then
  echo -e "${RED}No zip file found after download.${NC}" >&2
  exit 1
fi

echo -e "${BLUE}Extracting $DOWNLOADED_ZIP...${NC}"
echo -e "${BLUE}Extracting files:${NC}"
if unzip -o "$DOWNLOADED_ZIP" | grep -E "(inflating|extracting):" | sed "s/^/  ${CYAN}→${NC} /"; then
  echo -e "${GREEN}✓ Extraction complete.${NC}"
else
  echo -e "${RED}Failed to extract server files.${NC}" >&2
  exit 1
fi

# Expected structure after extraction: Server/ Assets.zip
echo -e "${BLUE}Copying server files to $SERVER_DIR...${NC}"
if [ -d "Server" ]; then
  FILE_COUNT=$(find Server -type f | wc -l)
  echo -e "${BLUE}Copying ${FILE_COUNT} files...${NC}"
  cp -rv Server/* "$SERVER_DIR/" 2>&1 | grep -v "^'" | sed "s/^/  ${CYAN}→${NC} /" || { echo -e "${RED}Failed to copy server files.${NC}" >&2; exit 1; }
  echo -e "${GREEN}✓ Server files copied.${NC}"
else
  echo -e "${RED}Server directory not found after extraction.${NC}" >&2
  exit 1
fi

if [ -f "Assets.zip" ]; then
  ASSETS_SIZE=$(du -h Assets.zip | cut -f1)
  echo -e "${BLUE}Copying Assets.zip (${ASSETS_SIZE})...${NC}"
  cp "Assets.zip" "$SERVER_DIR/" || { echo -e "${RED}Failed to copy Assets.zip.${NC}" >&2; exit 1; }
  echo -e "${GREEN}✓ Assets.zip copied.${NC}"
else
  echo -e "${RED}Assets.zip not found after extraction.${NC}" >&2
  exit 1
fi

# Clean up temporary files
echo -e "${BLUE}Cleaning up temporary files...${NC}"
rm -f "$DOWNLOADED_ZIP"
rm -rf Server
rm -f Assets.zip
rm -f QUICKSTART.md

echo -e "${CYAN}[5/7]${NC} Creating server start script..."

cat << 'EOF' > "$SERVER_DIR/start.sh"
#!/bin/bash
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
cd "$SCRIPT_DIR"
LOGS_DIR="$SCRIPT_DIR/logs"
SESSION_NAME="hytale-server"

# Monitor logs and send auth command when needed
monitor_and_auth() {
  # Wait for logs directory to be created
  while [ ! -d "$LOGS_DIR" ]; do
    sleep 1
  done
  
  echo "[AUTH] Monitoring logs for authentication requests..."
  local SENT_AUTH=false
  
  # Monitor the latest log file
  while true; do
    LATEST_LOG=$(ls -t "$LOGS_DIR"/*.log 2>/dev/null | head -1)
    if [ -n "$LATEST_LOG" ]; then
      # Check if server needs authentication
      if ! $SENT_AUTH && tail -50 "$LATEST_LOG" | grep -q "No server tokens configured"; then
        echo "[AUTH] Server needs authentication, configuring persistence and sending auth command..."
        sleep 3
        # First, set auth persistence to Encrypted
        tmux send-keys -t "$SESSION_NAME" "/auth persistence Encrypted" C-m
        sleep 1
        # Then send the auth login command
        tmux send-keys -t "$SESSION_NAME" "/auth login device" C-m
        SENT_AUTH=true
        echo "[AUTH] Auth commands sent. Waiting for authentication URL..."
      fi
      
      # Check if authentication URL was generated
      if grep -q "user_code=" "$LATEST_LOG" 2>/dev/null; then
        # Extract and display the URL
        AUTH_URL=$(grep -oP 'https://oauth\.accounts\.hytale\.com/oauth2/device/verify\?user_code=[A-Za-z0-9]+' "$LATEST_LOG" | tail -1)
        if [ -n "$AUTH_URL" ]; then
          echo ""
          echo "=========================================="
          echo "AUTHENTICATION REQUIRED"
          echo "Visit: $AUTH_URL"
          echo "=========================================="
          echo ""
          return 0
        fi
      fi
    fi
    sleep 2
  done
}

# Always start auth monitor in background
monitor_and_auth &
MONITOR_PID=$!

# Kill any existing tmux session
tmux kill-session -t "$SESSION_NAME" 2>/dev/null || true

# Start server in tmux session
tmux new-session -d -s "$SESSION_NAME" "cd '$SCRIPT_DIR' && java -jar HytaleServer.jar --assets Assets.zip"

echo "[INFO] Hytale server started in tmux session: $SESSION_NAME"
echo "[INFO] Attach with: tmux attach -t $SESSION_NAME"
echo "[INFO] Detach with: Ctrl+B then D"

# Keep the script running by monitoring the tmux session
while tmux has-session -t "$SESSION_NAME" 2>/dev/null; do
  sleep 5
done

# Clean up monitor if it's still running
kill $MONITOR_PID 2>/dev/null || true

echo "[INFO] Tmux session ended. Server stopped."
EOF


chmod +x "$SERVER_DIR/start.sh"
echo -e "${GREEN}Start script created at $SERVER_DIR/start.sh.${NC}"

echo -e "${CYAN}[6/7]${NC} Creating systemd service..."
sudo tee "$SERVICE_FILE" > /dev/null << EOF
[Unit]
Description=Hytale Dedicated Server
After=network.target

[Service]
User=$USER_NAME
WorkingDirectory=$SERVER_DIR
ExecStart=$SERVER_DIR/start.sh
Restart=always
RestartSec=5
StandardOutput=journal
StandardError=journal
LimitNOFILE=1048576

[Install]
WantedBy=multi-user.target
EOF


echo -e "${BLUE}Reloading systemd and enabling service...${NC}"
sudo systemctl daemon-reload
sudo systemctl enable hytale
echo -e "${GREEN}Hytale service enabled (will start on boot).${NC}"


# ---- 7. Open firewall (UDP / QUIC) ----
echo -e "${CYAN}[7/7]${NC} Configuring firewall..."
if command -v ufw >/dev/null 2>&1; then
  echo -e "${BLUE}Configuring UFW firewall...${NC}"
  sudo ufw allow ${CUSTOM_PORT}/udp
  echo -e "${GREEN}UFW rule added for UDP port ${CUSTOM_PORT}.${NC}"
else
  echo -e "${YELLOW}UFW not found. Please ensure UDP port ${CUSTOM_PORT} is open.${NC}"
fi


# ---- 8. Schedule 3-day service restart ----
echo -e "${CYAN}[8/8]${NC} Scheduling automatic service restart every 3 days..."
( sudo crontab -l 2>/dev/null | grep -v "systemctl restart hytale" ; echo "$RESTART_CRON" ) | sudo crontab -
echo -e "${GREEN}Service restart cron job set.${NC}"


# ---- DONE ----
echo ""
echo -e "${CYAN}[8/8]${NC} Finalizing installation..."

# Get server IPv4 address
SERVER_IP=$(hostname -I | grep -oE '([0-9]{1,3}\.){3}[0-9]{1,3}' | head -n1)

echo "=========================================="
echo "INSTALL COMPLETE!"
echo ""
echo -e "${YELLOW}Server is NOT started automatically.${NC}"
echo -e "${YELLOW}Start it with: ./installer.sh start${NC}"
echo ""
echo "NEXT STEPS:"
echo ""
echo "1) Start the server:"
echo "   ./installer start"
echo ""
echo "2) Attach to server console:"
echo "   ./installer console"
echo "   (Detach: Ctrl+B then D)"
echo ""
echo "3) Manage the service:"
echo "   ./installer start|stop"
echo ""
echo "=========================================="
echo "SERVER DETAILS:"
echo "IP Address: $SERVER_IP:$CUSTOM_PORT"
echo "Server Directory: $SERVER_DIR"
echo "Tmux Session: hytale-server"
echo "=========================================="
}

# Start server function
start_server() {
  echo ""
  echo -e "${CYAN}Starting Hytale server...${NC}"
  
  if ! systemctl list-unit-files | grep -q hytale.service; then
    echo -e "${RED}ERROR: Hytale server is not installed.${NC}"
    echo -e "${YELLOW}Please install it first.${NC}"
    exit 1
  fi
  
  if systemctl is-active --quiet hytale 2>/dev/null; then
    echo -e "${YELLOW}Server is already running.${NC}"
    exit 0
  fi
  
  sudo systemctl start hytale
  
  if systemctl is-active --quiet hytale; then
    echo -e "${GREEN}Hytale server started successfully.${NC}"
    echo ""
    
    # Only wait for authentication URL if auth.enc doesn't exist (first start)
    if [ ! -f "$SERVER_DIR/auth.enc" ]; then
      echo "Waiting for authentication URL..."
      sleep 5
      
      # Try to get auth URL from logs
      if [ -d "$SERVER_DIR/logs" ]; then
        for i in {1..6}; do
          LATEST_LOG=$(ls -t "$SERVER_DIR/logs"/*.log 2>/dev/null | head -1)
          if [ -n "$LATEST_LOG" ]; then
            AUTH_URL=$(grep -oP 'https://oauth\.accounts\.hytale\.com/oauth2/device/verify\?user_code=[A-Za-z0-9]+' "$LATEST_LOG" 2>/dev/null | tail -1)
            if [ -n "$AUTH_URL" ]; then
              echo ""
              echo "=========================================="
              echo "AUTHENTICATION REQUIRED:"
              echo "Visit: $AUTH_URL"
              echo "=========================================="
              echo ""
              break
            fi
          fi
          sleep 5
        done
      fi
    fi
    
    echo "Attach to console: ./installer.sh console"
  else
    echo -e "${RED}Failed to start Hytale server.${NC}" >&2
    exit 1
  fi
}

# Stop server function
stop_server() {
  echo ""
  echo -e "${CYAN}Stopping Hytale server...${NC}"
  
  if ! systemctl list-unit-files | grep -q hytale.service; then
    echo -e "${RED}ERROR: Hytale server is not installed.${NC}"
    exit 1
  fi
  
  if ! systemctl is-active --quiet hytale 2>/dev/null; then
    echo -e "${YELLOW}Server is not running.${NC}"
    exit 0
  fi
  
  sudo systemctl stop hytale
  echo -e "${GREEN}Hytale server stopped.${NC}"
}

# Console attachment function
attach_console() {
  echo ""
  if ! tmux has-session -t hytale-server 2>/dev/null; then
    echo -e "${RED}Error: Hytale server console session not found.${NC}"
    echo -e "${YELLOW}Is the server running? Check with: systemctl status hytale${NC}"
    exit 1
  fi
  
  echo -e "${CYAN}Attaching to Hytale server console...${NC}"
  echo -e "${YELLOW}Press Ctrl+B then D to detach${NC}"
  sleep 5
  tmux attach -t hytale-server
}

# Show usage information
show_usage() {
  echo -e "${CYAN}Hytale Dedicated Server Manager${NC}"
  echo ""
  echo "Usage: $0 [command]"
  echo ""
  echo "Commands:"
  echo "  install    - Install Hytale server"
  echo "  start      - Start Hytale server"
  echo "  stop       - Stop Hytale server"
  echo "  update     - Update Hytale server"
  echo "  uninstall  - Uninstall Hytale server"
  echo "  console    - Attach to server console"
  echo "  show       - Show interactive menu"
  echo ""
  echo "Run without arguments to use interactive menu."
}


# ================= COLORS =================
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m' # No Color
# =========================================


# ================= MAIN =================
# Parse command line arguments
if [ $# -eq 0 ]; then
  # No arguments, show interactive menu
  show_usage
else
  # Handle command line argument
  case "$1" in
    install)
      install_server
      ;;
    start)
      start_server
      ;;
    stop)
      stop_server
      ;;
    update)
      update_server
      ;;
    uninstall)
      uninstall_server
      ;;
    console)
      attach_console
      ;;
    show)
      show_menu
      ;;
    help|--help|-h)
      show_usage
      ;;
    *)
      echo -e "${RED}Error: Unknown command '$1'${NC}"
      echo ""
      show_usage
      exit 1
      ;;
  esac
fi