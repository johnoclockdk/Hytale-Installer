#!/bin/bash
set -e

# ================= CONFIG =================
USER_NAME=$(whoami)
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
BASE_DIR="$SCRIPT_DIR/hytale_server"
TOOLS_DIR="$SCRIPT_DIR/.hytale-tools"
TEMP_DIR="$SCRIPT_DIR/.hytale-temp"
BACKUP_DIR="$BASE_DIR/backups"
DOWNLOADER_URL="https://downloader.hytale.com/hytale-downloader.zip"
SERVICE_FILE="/etc/systemd/system/hytale.service" 
RESTART_CRON="0 0 */3 * * /usr/bin/systemctl restart hytale" # Every 3 days at midnight
BACKUP_CRON="0 0 * * * $(realpath $0) backup > /dev/null 2>&1" # Daily at midnight
BACKUP_RETENTION=7
PORT=5520
# =========================================

uninstall_server() {
  echo ""
  echo -e "${BOLD}${YELLOW}=== Uninstalling Hytale Server ===${NC}"
  echo ""
  
  # Use default port if CUSTOM_PORT is not set
  UNINSTALL_PORT=${CUSTOM_PORT:-$PORT}
  
  # Stop and disable service
  if systemctl is-active --quiet hytale 2>/dev/null; then
    echo -e "${BLUE}Stopping Hytale service...${NC}"
    sudo systemctl stop hytale
  fi
  
  if systemctl is-enabled --quiet hytale 2>/dev/null; then
    echo -e "${BLUE}Disabling Hytale service...${NC}"
    sudo systemctl disable hytale
  fi
  
  # Remove service file
  if [ -f "$SERVICE_FILE" ]; then
    echo -e "${BLUE}Removing service file...${NC}"
    sudo rm -f "$SERVICE_FILE"
    sudo systemctl daemon-reload
  fi
  
  # Remove server files
  if [ -d "$BASE_DIR" ]; then
    echo -e "${BLUE}Removing server files from $BASE_DIR...${NC}"
    rm -rf "$BASE_DIR"
  fi
  
  # Remove tools directory
  if [ -d "$TOOLS_DIR" ]; then
    echo -e "${BLUE}Removing tools directory...${NC}"
    rm -rf "$TOOLS_DIR"
  fi
  
  # Remove temp directory
  if [ -d "$TEMP_DIR" ]; then
    echo -e "${BLUE}Removing temp directory...${NC}"
    rm -rf "$TEMP_DIR"
  fi
  
  # Remove firewall rule
  if command -v ufw >/dev/null 2>&1; then
    echo -e "${BLUE}Removing firewall rule...${NC}"
    sudo ufw delete allow ${UNINSTALL_PORT}/udp 2>/dev/null || true
  fi
  
  # Remove cron jobs
  echo -e "${BLUE}Removing scheduled tasks...${NC}"
  sudo crontab -l 2>/dev/null | grep -v "systemctl restart hytale" | grep -v "backup > /dev/null" | sudo crontab - 2>/dev/null || true
  echo -e "${GREEN}✓ Scheduled tasks removed${NC}"
  
  echo ""
  echo -e "${GREEN}==========================================${NC}"
  echo -e "${BOLD}${GREEN}Uninstall complete!${NC}"
  echo -e "${GREEN}==========================================${NC}"
}
backup_server() {
  echo ""
  echo -e "${BOLD}${YELLOW}=== Creating Hytale Server Backup ===${NC}"
  echo ""
  
  # Create base directory and backup directory if they don't exist
  if [ ! -d "$BASE_DIR" ]; then
    echo -e "${YELLOW}WARNING: Server directory not found. Creating $BASE_DIR${NC}"
    mkdir -p "$BASE_DIR"
  fi
  
  # Ensure backup directory exists
  mkdir -p "$BACKUP_DIR"
  
  # Generate backup filename with timestamp
  BACKUP_NAME="hytale-backup-$(date +%Y%m%d-%H%M%S).tar.gz"
  BACKUP_PATH="$BACKUP_DIR/$BACKUP_NAME"
  
  echo -e "${CYAN}[1/3]${NC} Creating backup archive..."
  echo -e "${BLUE}Backing up world data and configuration files...${NC}"
  
  # Build list of files to backup
  BACKUP_ITEMS=()
  
  # Check and add universe folder
  if [ -d "$BASE_DIR/universe" ]; then
    BACKUP_ITEMS+=("universe")
    echo -e "${BLUE}  → universe/${NC}"
  fi
  
  # Check and add JSON files
  for file in bans.json config.json permissions.json whitelist.json; do
    if [ -f "$BASE_DIR/$file" ]; then
      BACKUP_ITEMS+=("$file")
      echo -e "${BLUE}  → $file${NC}"
    fi
  done
  
  if [ ${#BACKUP_ITEMS[@]} -eq 0 ]; then
    echo -e "${RED}No backup items found (universe folder or config files).${NC}"
    exit 1
  fi
  
  # Create compressed backup
  if tar -czf "$BACKUP_PATH" -C "$BASE_DIR" "${BACKUP_ITEMS[@]}" 2>/dev/null; then
    BACKUP_SIZE=$(du -h "$BACKUP_PATH" | cut -f1)
    echo -e "${GREEN}✓ Backup created: $BACKUP_NAME (${BACKUP_SIZE})${NC}"
  else
    echo -e "${RED}Failed to create backup.${NC}" >&2
    exit 1
  fi
  
  echo -e "${CYAN}[2/3]${NC} Managing backup retention..."
  # Count backups
  BACKUP_COUNT=$(ls -1 "$BACKUP_DIR"/hytale-backup-*.tar.gz 2>/dev/null | wc -l)
  echo -e "${BLUE}Total backups: ${BACKUP_COUNT}${NC}"
  
  # Remove old backups if exceeding retention
  if [ "$BACKUP_COUNT" -gt "$BACKUP_RETENTION" ]; then
    REMOVE_COUNT=$((BACKUP_COUNT - BACKUP_RETENTION))
    echo -e "${YELLOW}Removing ${REMOVE_COUNT} old backup(s)...${NC}"
    ls -1t "$BACKUP_DIR"/hytale-backup-*.tar.gz | tail -n "$REMOVE_COUNT" | xargs rm -f
    echo -e "${GREEN}✓ Old backups removed (keeping last ${BACKUP_RETENTION})${NC}"
  else
    echo -e "${GREEN}✓ Retention policy satisfied (keeping last ${BACKUP_RETENTION})${NC}"
  fi
  
  echo -e "${CYAN}[3/3]${NC} Backup complete!"
  echo ""
  echo -e "${GREEN}===========================================${NC}"
  echo -e "${BOLD}${GREEN}Backup saved to:${NC}"
  echo -e "${BLUE}$BACKUP_PATH${NC}"
  echo -e "${GREEN}===========================================${NC}"
}

restore_server() {
  echo ""
  echo -e "${BOLD}${YELLOW}=== Restoring Hytale Server from Backup ===${NC}"
  echo ""
  
  # Check if backup directory exists
  if [ ! -d "$BACKUP_DIR" ] || [ -z "$(ls -A "$BACKUP_DIR"/hytale-backup-*.tar.gz 2>/dev/null)" ]; then
    echo -e "${RED}ERROR: No backups found in $BACKUP_DIR${NC}"
    echo -e "${YELLOW}Create a backup first using: ./Hytale-Server backup${NC}"
    exit 1
  fi
  
  # List available backups
  echo -e "${CYAN}Available backups:${NC}"
  echo ""
  
  BACKUPS=($(ls -1t "$BACKUP_DIR"/hytale-backup-*.tar.gz 2>/dev/null))
  
  for i in "${!BACKUPS[@]}"; do
    BACKUP_FILE="${BACKUPS[$i]}"
    BACKUP_NAME=$(basename "$BACKUP_FILE")
    BACKUP_SIZE=$(du -h "$BACKUP_FILE" | cut -f1)
    BACKUP_DATE=$(echo "$BACKUP_NAME" | grep -oP '\d{8}-\d{6}' | sed 's/\([0-9]\{4\}\)\([0-9]\{2\}\)\([0-9]\{2\}\)-\([0-9]\{2\}\)\([0-9]\{2\}\)\([0-9]\{2\}\)/\1-\2-\3 \4:\5:\6/')
    echo -e "  ${BOLD}[$((i+1))]${NC} $BACKUP_DATE (${BACKUP_SIZE})"
  done
  
  echo ""
  read -p "Select backup to restore (1-${#BACKUPS[@]}) or 'q' to quit: " SELECTION
  
  if [ "$SELECTION" = "q" ] || [ "$SELECTION" = "Q" ]; then
    echo -e "${YELLOW}Restore cancelled.${NC}"
    exit 0
  fi
  
  # Validate selection
  if ! [[ "$SELECTION" =~ ^[0-9]+$ ]] || [ "$SELECTION" -lt 1 ] || [ "$SELECTION" -gt "${#BACKUPS[@]}" ]; then
    echo -e "${RED}Invalid selection.${NC}"
    exit 1
  fi
  
  SELECTED_BACKUP="${BACKUPS[$((SELECTION-1))]}"
  SELECTED_NAME=$(basename "$SELECTED_BACKUP")
  
  echo ""
  echo -e "${YELLOW}WARNING: This will replace all current server files!${NC}"
  read -p "Are you sure you want to restore from $SELECTED_NAME? (yes/no): " CONFIRM
  
  if [ "$CONFIRM" != "yes" ]; then
    echo -e "${YELLOW}Restore cancelled.${NC}"
    exit 0
  fi
  
  # Stop server if running
  if systemctl is-active --quiet hytale 2>/dev/null; then
    echo -e "${CYAN}[1/4]${NC} Stopping Hytale server..."
    sudo systemctl stop hytale
    echo -e "${GREEN}✓ Server stopped${NC}"
  else
    echo -e "${CYAN}[1/4]${NC} Server not running, proceeding..."
  fi
  
  # Backup current state (just in case)
  echo -e "${CYAN}[2/4]${NC} Creating safety backup of current state..."
  SAFETY_BACKUP="$BACKUP_DIR/pre-restore-$(date +%Y%m%d-%H%M%S).tar.gz"
  
  # Build safety backup items list
  SAFETY_ITEMS=()
  [ -d "$BASE_DIR/universe" ] && SAFETY_ITEMS+=("universe")
  for file in bans.json config.json permissions.json whitelist.json; do
    [ -f "$BASE_DIR/$file" ] && SAFETY_ITEMS+=("$file")
  done
  
  if [ ${#SAFETY_ITEMS[@]} -gt 0 ]; then
    tar -czf "$SAFETY_BACKUP" -C "$BASE_DIR" "${SAFETY_ITEMS[@]}" 2>/dev/null
    echo -e "${GREEN}✓ Safety backup created${NC}"
  else
    echo -e "${YELLOW}⚠ No existing data to backup${NC}"
  fi
  
  # Remove current world data and config files
  echo -e "${CYAN}[3/4]${NC} Removing current world data and config files..."
  [ -d "$BASE_DIR/universe" ] && rm -rf "$BASE_DIR/universe"
  for file in bans.json config.json permissions.json whitelist.json; do
    [ -f "$BASE_DIR/$file" ] && rm -f "$BASE_DIR/$file"
  done
  echo -e "${GREEN}✓ Current data removed${NC}"
  
  # Extract backup
  echo -e "${CYAN}[4/4]${NC} Restoring from backup..."
  if tar -xzf "$SELECTED_BACKUP" -C "$BASE_DIR" 2>/dev/null; then
    echo -e "${GREEN}✓ Backup restored successfully${NC}"
  else
    echo -e "${RED}Failed to restore backup!${NC}" >&2
    if [ -f "$SAFETY_BACKUP" ] && [ ${#SAFETY_ITEMS[@]} -gt 0 ]; then
      echo -e "${YELLOW}Attempting to restore safety backup...${NC}"
      tar -xzf "$SAFETY_BACKUP" -C "$BASE_DIR" 2>/dev/null
    fi
    exit 1
  fi
  
  # Ask to restart server
  echo ""
  read -p "Start the server now? (yes/no): " START_NOW
  
  if [ "$START_NOW" = "yes" ]; then
    sudo systemctl start hytale
    echo -e "${GREEN}Server started.${NC}"
  fi
  
  echo ""
  echo -e "${GREEN}===========================================${NC}"
  echo -e "${BOLD}${GREEN}Restore complete!${NC}"
  echo -e "${BLUE}Restored from: $SELECTED_NAME${NC}"
  echo -e "${GREEN}===========================================${NC}"
}

toggle_autobackup() {
  echo ""
  echo -e "${BOLD}${YELLOW}=== Auto-Backup Configuration ===${NC}"
  echo ""
  
  # Check if auto-backup cron exists
  if sudo crontab -l 2>/dev/null | grep -q "backup > /dev/null"; then
    echo -e "${YELLOW}Auto-backup is currently: ${BOLD}ENABLED${NC}"
    echo ""
    read -p "Do you want to disable auto-backup? (yes/no): " DISABLE
    
    if [ "$DISABLE" = "yes" ]; then
      sudo crontab -l 2>/dev/null | grep -v "backup > /dev/null" | sudo crontab - || true
      echo -e "${GREEN}✓ Auto-backup disabled${NC}"
    else
      echo -e "${YELLOW}Auto-backup remains enabled${NC}"
    fi
  else
    echo -e "${YELLOW}Auto-backup is currently: ${BOLD}DISABLED${NC}"
    echo ""
    echo -e "${CYAN}Configure automatic daily backups:${NC}"
    read -p "Enable auto-backup? (yes/no): " ENABLE
    
    if [ "$ENABLE" = "yes" ]; then
      ( sudo crontab -l 2>/dev/null | grep -v "backup > /dev/null" ; echo "$BACKUP_CRON" ) | sudo crontab - || true
      
      echo -e "${GREEN}✓ Auto-backup enabled${NC}"
      echo -e "${BLUE}Backups will run daily at 2:00 AM${NC}"
      echo -e "${BLUE}Retention: ${BACKUP_RETENTION} backups${NC}"
    else
      echo -e "${YELLOW}Auto-backup remains disabled${NC}"
    fi
  fi
  
  echo ""
  echo -e "${GREEN}===========================================${NC}"
}

toggle_autorestart() {
  echo ""
  echo -e "${BOLD}${YELLOW}=== Auto-Restart Configuration ===${NC}"
  echo ""
  
  # Check if auto-restart cron exists
  if sudo crontab -l 2>/dev/null | grep -q "systemctl restart hytale"; then
    echo -e "${YELLOW}Auto-restart is currently: ${BOLD}ENABLED${NC}"
    echo ""
    read -p "Do you want to disable auto-restart? (yes/no): " DISABLE
    
    if [ "$DISABLE" = "yes" ]; then
      sudo crontab -l 2>/dev/null | grep -v "systemctl restart hytale" | sudo crontab - || true
      echo -e "${GREEN}✓ Auto-restart disabled${NC}"
    else
      echo -e "${YELLOW}Auto-restart remains enabled${NC}"
    fi
  else
    echo -e "${YELLOW}Auto-restart is currently: ${BOLD}DISABLED${NC}"
    echo ""
    echo -e "${CYAN}Configure automatic server restart every 3 days:${NC}"
    read -p "Enable auto-restart? (yes/no): " ENABLE
    
    if [ "$ENABLE" = "yes" ]; then
      ( sudo crontab -l 2>/dev/null | grep -v "systemctl restart hytale" ; echo "$RESTART_CRON" ) | sudo crontab - || true
      
      echo -e "${GREEN}✓ Auto-restart enabled${NC}"
      echo -e "${BLUE}Server will restart every 3 days at midnight${NC}"
    else
      echo -e "${YELLOW}Auto-restart remains disabled${NC}"
    fi
  fi
  
  echo ""
  echo -e "${GREEN}===========================================${NC}"
}
update_server() {
  echo ""
  echo -e "${BOLD}${YELLOW}=== Updating Hytale Server ===${NC}"
  echo ""
  
  # Check if server is installed
  if ! systemctl list-unit-files | grep -q hytale.service; then
    echo -e "${RED}ERROR: Hytale server is not installed.${NC}"
    echo -e "${YELLOW}Please install it first using option 1.${NC}"
    exit 1
  fi
  
  echo -e "${CYAN}[1/5]${NC} Stopping Hytale service..."
  sudo systemctl stop hytale
  
  # Create temp directory
  mkdir -p "$TEMP_DIR"
  mkdir -p "$TOOLS_DIR"
  
  echo -e "${CYAN}[2/5]${NC} Downloading Hytale Downloader..."
  cd "$TEMP_DIR" || { echo -e "${RED}Failed to change to $TEMP_DIR.${NC}" >&2; exit 1; }
  
  if [ ! -f "$TOOLS_DIR/hytale-downloader-linux-amd64" ]; then
    if wget --no-cookies --no-cache --show-progress -O hytale-downloader.zip "$DOWNLOADER_URL"; then
      if unzip -q hytale-downloader.zip; then
        chmod +x hytale-downloader-linux-amd64
        mv hytale-downloader-linux-amd64 "$TOOLS_DIR/"
        rm -f hytale-downloader-windows-amd64.exe hytale-downloader.zip QUICKSTART.md
      fi
    fi
  fi
  
  # Copy credentials if they exist
  [ -f "$TOOLS_DIR/.hytale-downloader-credentials.json" ] && cp "$TOOLS_DIR/.hytale-downloader-credentials.json" .
  
  echo -e "${CYAN}[3/5]${NC} Downloading latest server files..."
  if "$TOOLS_DIR/hytale-downloader-linux-amd64"; then
    echo -e "${GREEN}Server files downloaded.${NC}"
  else
    echo -e "${RED}Failed to download server files.${NC}" >&2
    exit 1
  fi
  
  DOWNLOADED_ZIP=$(ls -t *.zip 2>/dev/null | head -1)
  
  if [ -z "$DOWNLOADED_ZIP" ]; then
    echo -e "${RED}No zip file found after download.${NC}" >&2
    exit 1
  fi
  
  echo -e "${CYAN}[4/5]${NC} Extracting and updating server files..."
  echo -e "${BLUE}Extracting files:${NC}"
  if unzip -o "$DOWNLOADED_ZIP" | grep -E "(inflating|extracting):" | sed "s/^/  ${CYAN}→${NC} /"; then
    echo -e "${GREEN}✓ Extraction complete.${NC}"
  else
    echo -e "${RED}Failed to extract server files.${NC}" >&2
    exit 1
  fi
  
  # Update server files (keep existing config and world data)
  if [ -d "Server" ]; then
    # Remove old server files but keep world data, configs, and start script
    find "$BASE_DIR" -mindepth 1 -maxdepth 1 ! -name 'universe' ! -name '*.json' ! -name 'backups' ! -name 'logs' ! -name '*.sh' ! -name '*.enc' -exec rm -rf {} + 2>/dev/null || true
    cp -r Server/* "$BASE_DIR/" || { echo "Failed to copy server files." >&2; exit 1; }
  fi
  
  if [ -f "Assets.zip" ]; then
    cp "Assets.zip" "$BASE_DIR/" || { echo "Failed to copy Assets.zip." >&2; exit 1; }
  fi
  
  # Save credentials back to tools directory
  [ -f ".hytale-downloader-credentials.json" ] && cp ".hytale-downloader-credentials.json" "$TOOLS_DIR/"
  
  # Clean up temp directory
  cd "$BASE_DIR" || exit 1
  rm -rf "$TEMP_DIR"
  mkdir -p "$TEMP_DIR"
  
  echo -e "${CYAN}[5/5]${NC} Starting Hytale service..."
  sudo systemctl start hytale
  
  echo ""
  echo -e "${GREEN}==========================================${NC}"
  echo -e "${BOLD}${GREEN}Update complete!${NC}"
  echo -e "${GREEN}==========================================${NC}"
}

install_server() {
  echo ""
  echo -e "${BOLD}${CYAN}=== Installing Hytale Dedicated Server ===${NC}"
  echo ""
  
  # Check if already installed
  if systemctl is-active --quiet hytale 2>/dev/null; then
    echo -e "${YELLOW}WARNING: Hytale service is already running!${NC}"
    echo -e "${YELLOW}Please uninstall first using option 3.${NC}"
    exit 1
  fi

  # Port configuration
  echo -e "${CYAN}Port Configuration${NC}"
  read -p "Enter server port (default: 5520): " CUSTOM_PORT
  
  if [ -z "$CUSTOM_PORT" ]; then
    CUSTOM_PORT=$PORT
    echo -e "${BLUE}Using default port: ${CUSTOM_PORT}${NC}"
  else
    # Validate port number
    if ! [[ "$CUSTOM_PORT" =~ ^[0-9]+$ ]] || [ "$CUSTOM_PORT" -lt 1024 ] || [ "$CUSTOM_PORT" -gt 65535 ]; then
      echo -e "${RED}Invalid port number. Must be between 1024 and 65535.${NC}"
      exit 1
    fi
    echo -e "${GREEN}Using custom port: ${CUSTOM_PORT}${NC}"
  fi
  echo ""

  # Auto-backup configuration
  echo -e "${CYAN}Auto-Backup Configuration${NC}"
  echo -e "${BLUE}Would you like to enable automatic daily backups?${NC}"
  read -p "Enable auto-backup? (yes/no): " ENABLE_AUTOBACKUP
  echo ""

  # Auto-restart configuration
  echo -e "${CYAN}Auto-Restart Configuration${NC}"
  echo -e "${BLUE}Would you like to enable automatic server restart every 3 days?${NC}"
  echo -e "${YELLOW}(Helps keep server running smoothly and apply updates)${NC}"
  read -p "Enable auto-restart? (yes/no): " ENABLE_AUTORESTART
  echo ""

echo -e "${CYAN}[1/7]${NC} Checking dependencies..."

# Check and install unzip if missing
if ! command -v unzip >/dev/null 2>&1; then
  echo -e "${BLUE}Installing unzip...${NC}"
  sudo apt-get update -qq
  sudo apt-get install -y unzip
  echo -e "${GREEN}✓ unzip installed.${NC}"
else
  echo -e "${GREEN}✓ unzip is already installed.${NC}"
fi

# Check and install tmux if missing
if ! command -v tmux >/dev/null 2>&1; then
  echo -e "${BLUE}Installing tmux...${NC}"
  sudo apt-get install -y tmux
  echo -e "${GREEN}✓ tmux installed.${NC}"
else
  echo -e "${GREEN}✓ tmux is already installed.${NC}"
fi

# Check and install cron if missing
if ! command -v crontab >/dev/null 2>&1; then
  echo -e "${BLUE}Installing cron...${NC}"
  sudo apt-get install -y cron
  # Ensure cron service is enabled and started
  sudo systemctl enable cron 2>/dev/null || true
  sudo systemctl start cron 2>/dev/null || true
  echo -e "${GREEN}✓ cron installed.${NC}"
else
  echo -e "${GREEN}✓ cron is already installed.${NC}"
fi

echo -e "${BLUE}Checking Java installation...${NC}"
JAVA_VERSION_OUTPUT=$(java -version 2>&1 || true)
JAVA_VERSION=$(echo "$JAVA_VERSION_OUTPUT" | awk -F[\".] '/version/ {print $2}')

if [[ "$JAVA_VERSION_OUTPUT" == *"25."* || "$JAVA_VERSION" == "25" ]]; then
  echo -e "${GREEN}✓ Java 25 is already installed.${NC}"
else
  echo -e "${BLUE}Installing Java 25...${NC}"
  if wget --no-cookies --no-cache -q --show-progress https://download.oracle.com/java/25/latest/jdk-25_linux-x64_bin.deb; then
    if sudo dpkg -i jdk-25_linux-x64_bin.deb; then
      echo -e "${GREEN}✓ Java 25 installed successfully.${NC}"
      rm jdk-25_linux-x64_bin.deb
    else
      echo -e "${RED}Failed to install Java.${NC}" >&2
      exit 1
    fi
  else
    echo -e "${RED}Failed to download Java installer.${NC}" >&2
    exit 1
  fi
fi

java --version || { echo "Java not found in PATH." >&2; exit 1; }

# Check available disk space
echo -e "${BLUE}Checking available disk space...${NC}"
REQUIRED_SPACE_MB=5120  # 5 GB in MB
AVAILABLE_SPACE_MB=$(df -BM "$(pwd)" | awk 'NR==2 {print $4}' | sed 's/M//')

if [ "$AVAILABLE_SPACE_MB" -lt "$REQUIRED_SPACE_MB" ]; then
  echo -e "${RED}ERROR: Insufficient disk space.${NC}"
  echo -e "${YELLOW}Required: ${REQUIRED_SPACE_MB} MB (5 GB)${NC}"
  echo -e "${YELLOW}Available: ${AVAILABLE_SPACE_MB} MB${NC}"
  exit 1
else
  echo -e "${GREEN}✓ Sufficient disk space available (${AVAILABLE_SPACE_MB} MB).${NC}"
fi


# ---- 2. Create directories ----
echo -e "${CYAN}[2/7]${NC} Creating directories..."
mkdir -p "$BASE_DIR"
mkdir -p "$TOOLS_DIR"
mkdir -p "$TEMP_DIR"


# ---- 3. Install Hytale Downloader CLI ----
echo -e "${CYAN}[3/7]${NC} Downloading Hytale Downloader..."
cd "$TEMP_DIR" || { echo -e "${RED}Failed to change to $TEMP_DIR.${NC}" >&2; exit 1; }

if wget --no-cookies --no-cache --show-progress -O hytale-downloader.zip "$DOWNLOADER_URL"; then
  echo -e "${GREEN}Hytale Downloader downloaded.${NC}"
else
  echo -e "${RED}Failed to download Hytale Downloader.${NC}" >&2
  exit 1
fi
echo -e "${BLUE}Extracting Hytale Downloader...${NC}"
if unzip -q hytale-downloader.zip; then
  echo -e "${GREEN}✓ Extraction complete.${NC}"
else
  echo -e "${RED}Failed to extract Hytale Downloader.${NC}" >&2
  exit 1
fi

chmod +x hytale-downloader-linux-amd64
mv hytale-downloader-linux-amd64 "$TOOLS_DIR/"
rm -f hytale-downloader-windows-amd64.exe hytale-downloader.zip QUICKSTART.md


# ---- 4. Download server files ----
echo -e "${CYAN}[4/7]${NC} Downloading Hytale server files..."
cd "$TEMP_DIR" || { echo -e "${RED}Failed to change to $TEMP_DIR.${NC}" >&2; exit 1; }
if "$TOOLS_DIR/hytale-downloader-linux-amd64"; then
  echo -e "${GREEN}Server files downloaded.${NC}"
else
  echo -e "${RED}Failed to download server files.${NC}" >&2
  exit 1
fi

# Save credentials to tools directory
[ -f ".hytale-downloader-credentials.json" ] && cp ".hytale-downloader-credentials.json" "$TOOLS_DIR/"

# Expected structure: The downloader creates a zip file like "2026.01.15-c04fdfe10.zip"
# Find the most recently created zip file
DOWNLOADED_ZIP=$(ls -t *.zip 2>/dev/null | head -1)

if [ -z "$DOWNLOADED_ZIP" ]; then
  echo -e "${RED}No zip file found after download.${NC}" >&2
  exit 1
fi

echo -e "${BLUE}Extracting $DOWNLOADED_ZIP...${NC}"
echo -e "${BLUE}Extracting files:${NC}"
if unzip -o "$DOWNLOADED_ZIP" | grep -E "(inflating|extracting):" | sed "s/^/  ${CYAN}→${NC} /"; then
  echo -e "${GREEN}✓ Extraction complete.${NC}"
else
  echo -e "${RED}Failed to extract server files.${NC}" >&2
  exit 1
fi

# Expected structure after extraction: Server/ Assets.zip
echo -e "${BLUE}Copying server files to $BASE_DIR...${NC}"
if [ -d "Server" ]; then
  FILE_COUNT=$(find Server -type f | wc -l)
  echo -e "${BLUE}Copying ${FILE_COUNT} files...${NC}"
  cp -rv Server/* "$BASE_DIR/" 2>&1 | grep -v "^'" | sed "s/^/  ${CYAN}→${NC} /" || { echo -e "${RED}Failed to copy server files.${NC}" >&2; exit 1; }
  echo -e "${GREEN}✓ Server files copied.${NC}"
else
  echo -e "${RED}Server directory not found after extraction.${NC}" >&2
  exit 1
fi

if [ -f "Assets.zip" ]; then
  ASSETS_SIZE=$(du -h Assets.zip | cut -f1)
  echo -e "${BLUE}Copying Assets.zip (${ASSETS_SIZE})...${NC}"
  cp "Assets.zip" "$BASE_DIR/" || { echo -e "${RED}Failed to copy Assets.zip.${NC}" >&2; exit 1; }
  echo -e "${GREEN}✓ Assets.zip copied.${NC}"
else
  echo -e "${RED}Assets.zip not found after extraction.${NC}" >&2
  exit 1
fi

# Clean up temp directory
echo -e "${BLUE}Cleaning up temporary files...${NC}"
cd "$BASE_DIR" || exit 1
rm -rf "$TEMP_DIR"
mkdir -p "$TEMP_DIR"

echo -e "${CYAN}[5/7]${NC} Creating server start script..."

cat << 'EOF' > "$BASE_DIR/start.sh"
#!/bin/bash
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
cd "$SCRIPT_DIR"
LOGS_DIR="$SCRIPT_DIR/logs"
SESSION_NAME="hytale-server"

# Monitor logs and send auth command when needed
monitor_and_auth() {
  # Wait for logs directory to be created
  while [ ! -d "$LOGS_DIR" ]; do
    sleep 1
  done
  
  echo "[AUTH] Monitoring logs for authentication requests..."
  local SENT_AUTH=false
  
  # Monitor the latest log file
  while true; do
    LATEST_LOG=$(ls -t "$LOGS_DIR"/*.log 2>/dev/null | head -1)
    if [ -n "$LATEST_LOG" ]; then
      # Check if server needs authentication
      if ! $SENT_AUTH && tail -50 "$LATEST_LOG" | grep -q "No server tokens configured"; then
        echo "[AUTH] Server needs authentication, configuring persistence and sending auth command..."
        sleep 3
        # First, set auth persistence to Encrypted
        tmux send-keys -t "$SESSION_NAME" "/auth persistence Encrypted" C-m
        sleep 1
        # Then send the auth login command
        tmux send-keys -t "$SESSION_NAME" "/auth login device" C-m
        SENT_AUTH=true
        echo "[AUTH] Auth commands sent. Waiting for authentication URL..."
      fi
      
      # Check if authentication URL was generated
      if grep -q "user_code=" "$LATEST_LOG" 2>/dev/null; then
        # Extract and display the URL
        AUTH_URL=$(grep -oP 'https://oauth\.accounts\.hytale\.com/oauth2/device/verify\?user_code=[A-Za-z0-9]+' "$LATEST_LOG" | tail -1)
        if [ -n "$AUTH_URL" ]; then
          echo ""
          echo "=========================================="
          echo "AUTHENTICATION REQUIRED"
          echo "Visit: $AUTH_URL"
          echo "=========================================="
          echo ""
          return 0
        fi
      fi
    fi
    sleep 2
  done
}

# Always start auth monitor in background
monitor_and_auth &
MONITOR_PID=$!

# Kill any existing tmux session
tmux kill-session -t "$SESSION_NAME" 2>/dev/null || true

# Start server in tmux session
tmux new-session -d -s "$SESSION_NAME" "cd '$SCRIPT_DIR' && java -jar HytaleServer.jar --assets Assets.zip"

echo "[INFO] Hytale server started in tmux session: $SESSION_NAME"
echo "[INFO] Attach with: tmux attach -t $SESSION_NAME"
echo "[INFO] Detach with: Ctrl+B then D"

# Keep the script running by monitoring the tmux session
while tmux has-session -t "$SESSION_NAME" 2>/dev/null; do
  sleep 5
done

# Clean up monitor if it's still running
kill $MONITOR_PID 2>/dev/null || true

echo "[INFO] Tmux session ended. Server stopped."
EOF


chmod +x "$BASE_DIR/start.sh"
echo -e "${GREEN}Start script created at $BASE_DIR/start.sh.${NC}"

echo -e "${CYAN}[6/7]${NC} Creating systemd service..."
sudo tee "$SERVICE_FILE" > /dev/null << EOF
[Unit]
Description=Hytale Dedicated Server
After=network.target

[Service]
User=$USER_NAME
WorkingDirectory=$BASE_DIR
ExecStart=$BASE_DIR/start.sh
Restart=always
RestartSec=5
StandardOutput=journal
StandardError=journal
LimitNOFILE=1048576

[Install]
WantedBy=multi-user.target
EOF


echo -e "${BLUE}Reloading systemd and enabling service...${NC}"
sudo systemctl daemon-reload
sudo systemctl enable hytale
echo -e "${GREEN}Hytale service enabled (will start on boot).${NC}"


# ---- 7. Open firewall (UDP / QUIC) ----
echo -e "${CYAN}[7/7]${NC} Configuring firewall..."
if command -v ufw >/dev/null 2>&1; then
  echo -e "${BLUE}Configuring UFW firewall...${NC}"
  sudo ufw allow ${CUSTOM_PORT}/udp
  echo -e "${GREEN}UFW rule added for UDP port ${CUSTOM_PORT}.${NC}"
else
  echo -e "${YELLOW}UFW not found. Please ensure UDP port ${CUSTOM_PORT} is open.${NC}"
fi


# ---- 8. Configure automatic tasks ----
echo -e "${CYAN}[8/8]${NC} Configuring automatic tasks..."

if [ "$ENABLE_AUTORESTART" = "yes" ]; then
  echo -e "${BLUE}Setting up auto-restart...${NC}"
  ( sudo crontab -l 2>/dev/null | grep -v "systemctl restart hytale" ; echo "$RESTART_CRON" ) | sudo crontab - || true
  echo -e "${GREEN}✓ Auto-restart enabled${NC}"
  echo -e "${BLUE}  → Server will restart every 3 days at midnight${NC}"
fi

if [ "$ENABLE_AUTOBACKUP" = "yes" ]; then
  echo -e "${BLUE}Setting up auto-backup...${NC}"
  ( sudo crontab -l 2>/dev/null | grep -v "backup > /dev/null" ; echo "$BACKUP_CRON" ) | sudo crontab - || true
  
  echo -e "${GREEN}✓ Auto-backup enabled${NC}"
  echo -e "${BLUE}  → Backups will run daily at 2:00 AM${NC}"
  echo -e "${BLUE}  → Retention: ${BACKUP_RETENTION} backups${NC}"
fi

if [ "$ENABLE_AUTORESTART" != "yes" ] && [ "$ENABLE_AUTOBACKUP" != "yes" ]; then
  echo -e "${YELLOW}No automatic tasks configured.${NC}"
  echo -e "${YELLOW}You can enable them later with: ./Hytale-Server autobackup${NC}"
fi


# ---- DONE ----
echo ""
echo -e "${CYAN}Finalizing installation...${NC}"

# Get server IPv4 address
SERVER_IP=$(hostname -I | grep -oE '([0-9]{1,3}\.){3}[0-9]{1,3}' | head -n1)

echo "=========================================="
echo "INSTALL COMPLETE!"
echo ""
echo -e "${YELLOW}Server is NOT started automatically.${NC}"
echo -e "${YELLOW}Start it with: ./Hytale-Server start${NC}"
echo ""
echo "NEXT STEPS:"
echo ""
echo "1) Start the server:"
echo "   ./Hytale-Server start"
echo ""
echo "2) Attach to server console:"
echo "   ./Hytale-Server console"
echo "   (Detach: Ctrl+B then D)"
echo ""
echo "3) Manage the service:"
echo "   ./Hytale-Server start|stop"
echo ""
echo "=========================================="
echo "SERVER DETAILS:"
echo "IP Address: $SERVER_IP:$CUSTOM_PORT"
echo "Server Directory: $BASE_DIR"
echo "Tools Directory: $TOOLS_DIR"
echo "Tmux Session: hytale-server"
echo "=========================================="
}

# Show server status
show_status() {
  echo ""
  echo -e "${BOLD}${CYAN}=== Hytale Server Status ===${NC}"
  echo ""
  
  # Check if installed
  if ! systemctl list-unit-files | grep -q hytale.service; then
    echo -e "${RED}Server: NOT INSTALLED${NC}"
    echo ""
    echo -e "${YELLOW}Run './Hytale-Server install' to install the server.${NC}"
    return
  fi
  
  # Server status
  if systemctl is-active --quiet hytale 2>/dev/null; then
    echo -e "${GREEN}Server Status: RUNNING ✓${NC}"
  else
    echo -e "${RED}Server Status: STOPPED ✗${NC}"
  fi
  
  # Auto-start on boot
  if systemctl is-enabled --quiet hytale 2>/dev/null; then
    echo -e "${GREEN}Auto-start: ENABLED ✓${NC}"
  else
    echo -e "${YELLOW}Auto-start: DISABLED ✗${NC}"
  fi
  
  echo ""
  echo -e "${BOLD}${CYAN}Scheduled Tasks:${NC}"
  
  # Auto-backup status
  if sudo crontab -l 2>/dev/null | grep -q "backup > /dev/null"; then
    echo -e "${GREEN}Auto-backup: ENABLED ✓${NC}"
    echo -e "${BLUE}  → Daily at 2:00 AM${NC}"
    echo -e "${BLUE}  → Retention: ${BACKUP_RETENTION} backups${NC}"
    
    # Calculate time until next backup
    CURRENT_HOUR=$(date +%H)
    CURRENT_MIN=$(date +%M)
    CURRENT_TIME_MIN=$((CURRENT_HOUR * 60 + CURRENT_MIN))
    BACKUP_TIME_MIN=$((2 * 60))  # 2:00 AM
    
    if [ $CURRENT_TIME_MIN -lt $BACKUP_TIME_MIN ]; then
      # Next run is today
      MINUTES_UNTIL=$((BACKUP_TIME_MIN - CURRENT_TIME_MIN))
    else
      # Next run is tomorrow
      MINUTES_UNTIL=$((1440 - CURRENT_TIME_MIN + BACKUP_TIME_MIN))
    fi
    
    HOURS_UNTIL=$((MINUTES_UNTIL / 60))
    MINS_UNTIL=$((MINUTES_UNTIL % 60))
    
    if [ $HOURS_UNTIL -gt 0 ]; then
      echo -e "${BLUE}  → Next run in: ${HOURS_UNTIL}h ${MINS_UNTIL}m${NC}"
    else
      echo -e "${BLUE}  → Next run in: ${MINS_UNTIL}m${NC}"
    fi
  else
    echo -e "${YELLOW}Auto-backup: DISABLED ✗${NC}"
  fi
  
  # Auto-restart status
  if sudo crontab -l 2>/dev/null | grep -q "systemctl restart hytale"; then
    echo -e "${GREEN}Auto-restart: ENABLED ✓${NC}"
    echo -e "${BLUE}  → Every 3 days at midnight${NC}"
    
    # Calculate time until next restart (approximate - shows next midnight)
    CURRENT_HOUR=$(date +%H)
    CURRENT_MIN=$(date +%M)
    CURRENT_TIME_MIN=$((CURRENT_HOUR * 60 + CURRENT_MIN))
    RESTART_TIME_MIN=0  # Midnight
    
    if [ $CURRENT_TIME_MIN -eq 0 ]; then
      # It's midnight now
      echo -e "${BLUE}  → Next run in: <1m${NC}"
    else
      # Next run is tomorrow at midnight
      MINUTES_UNTIL=$((1440 - CURRENT_TIME_MIN))
      HOURS_UNTIL=$((MINUTES_UNTIL / 60))
      MINS_UNTIL=$((MINUTES_UNTIL % 60))
      
      if [ $HOURS_UNTIL -gt 0 ]; then
        echo -e "${BLUE}  → Next check in: ${HOURS_UNTIL}h ${MINS_UNTIL}m${NC}"
      else
        echo -e "${BLUE}  → Next check in: ${MINS_UNTIL}m${NC}"
      fi
    fi
  else
    echo -e "${YELLOW}Auto-restart: DISABLED ✗${NC}"
  fi
  
  echo ""
  echo -e "${BOLD}${CYAN}Server Details:${NC}"
  
  if [ -d "$BASE_DIR" ]; then
    # Get port from config if exists
    if [ -f "$BASE_DIR/config.json" ] && command -v jq >/dev/null 2>&1; then
      SERVER_PORT=$(jq -r '.server.port // empty' "$BASE_DIR/config.json" 2>/dev/null || echo "$PORT")
    else
      SERVER_PORT="$PORT"
    fi
    
    SERVER_IP=$(hostname -I | grep -oE '([0-9]{1,3}\.){3}[0-9]{1,3}' | head -n1)
    echo -e "${BLUE}IP Address: ${SERVER_IP}:${SERVER_PORT}${NC}"
    echo -e "${BLUE}Directory: $BASE_DIR${NC}"
    
    # Backup count
    if [ -d "$BACKUP_DIR" ]; then
      BACKUP_COUNT=$(ls -1 "$BACKUP_DIR"/hytale-backup-*.tar.gz 2>/dev/null | wc -l)
      echo -e "${BLUE}Backups: ${BACKUP_COUNT}${NC}"
    fi
    
    # Auth status
    if [ -f "$BASE_DIR/auth.enc" ]; then
      echo -e "${GREEN}Authentication: CONFIGURED ✓${NC}"
    else
      echo -e "${YELLOW}Authentication: PENDING ✗${NC}"
    fi
  fi
  
  echo ""
  echo -e "${GREEN}===========================================${NC}"
}

# View server logs
view_logs() {
  echo ""
  
  if [ ! -d "$BASE_DIR/logs" ]; then
    echo -e "${RED}Error: Logs directory not found.${NC}"
    echo -e "${YELLOW}Has the server been started yet?${NC}"
    exit 1
  fi
  
  LATEST_LOG=$(ls -t "$BASE_DIR/logs"/*.log 2>/dev/null | head -1)
  
  if [ -z "$LATEST_LOG" ]; then
    echo -e "${RED}Error: No log files found.${NC}"
    exit 1
  fi
  
  echo -e "${CYAN}Viewing latest log: $(basename "$LATEST_LOG")${NC}"
  echo -e "${YELLOW}Press Ctrl+C to stop${NC}"
  echo ""
  sleep 2
  
  tail -f "$LATEST_LOG"
}

# Start server function
start_server() {
  echo ""
  echo -e "${CYAN}Starting Hytale server...${NC}"
  
  if ! systemctl list-unit-files | grep -q hytale.service; then
    echo -e "${RED}ERROR: Hytale server is not installed.${NC}"
    echo -e "${YELLOW}Please install it first.${NC}"
    exit 1
  fi
  
  if systemctl is-active --quiet hytale 2>/dev/null; then
    echo -e "${YELLOW}Server is already running.${NC}"
    exit 0
  fi
  
  sudo systemctl start hytale
  
  if systemctl is-active --quiet hytale; then
    echo -e "${GREEN}Hytale server started successfully.${NC}"
    echo ""
    
    # Only wait for authentication URL if auth.enc doesn't exist (first start)
    if [ ! -f "$BASE_DIR/auth.enc" ]; then
      echo "Waiting for authentication URL..."
      sleep 5
      
      # Try to get auth URL from logs
      if [ -d "$BASE_DIR/logs" ]; then
        for i in {1..6}; do
          LATEST_LOG=$(ls -t "$BASE_DIR/logs"/*.log 2>/dev/null | head -1)
          if [ -n "$LATEST_LOG" ]; then
            AUTH_URL=$(grep -oP 'https://oauth\.accounts\.hytale\.com/oauth2/device/verify\?user_code=[A-Za-z0-9]+' "$LATEST_LOG" 2>/dev/null | tail -1)
            if [ -n "$AUTH_URL" ]; then
              echo ""
              echo "=========================================="
              echo "AUTHENTICATION REQUIRED:"
              echo "Visit: $AUTH_URL"
              echo "=========================================="
              echo ""
              break
            fi
          fi
          sleep 5
        done
      fi
    fi
    
    echo "Attach to console: ./Hytale-Server console"
  else
    echo -e "${RED}Failed to start Hytale server.${NC}" >&2
    exit 1
  fi
}

# Stop server function
stop_server() {
  echo ""
  echo -e "${CYAN}Stopping Hytale server...${NC}"
  
  if ! systemctl list-unit-files | grep -q hytale.service; then
    echo -e "${RED}ERROR: Hytale server is not installed.${NC}"
    exit 1
  fi
  
  if ! systemctl is-active --quiet hytale 2>/dev/null; then
    echo -e "${YELLOW}Server is not running.${NC}"
    exit 0
  fi
  
  sudo systemctl stop hytale
  echo -e "${GREEN}Hytale server stopped.${NC}"
}

# Console attachment function
attach_console() {
  echo ""
  if ! tmux has-session -t hytale-server 2>/dev/null; then
    echo -e "${RED}Error: Hytale server console session not found.${NC}"
    echo -e "${YELLOW}Is the server running? Check with: systemctl status hytale${NC}"
    exit 1
  fi
  
  echo -e "${CYAN}Attaching to Hytale server console...${NC}"
  echo -e "${YELLOW}Press Ctrl+B then D to detach${NC}"
  sleep 5
  tmux attach -t hytale-server
}

# Show usage information
show_usage() {
  echo -e "${CYAN}Hytale Dedicated Server Manager${NC}"
  echo ""
  echo "Usage: $0 [command]"
  echo ""
  echo "Commands:"
  echo "  install      - Install Hytale server"
  echo "  start        - Start Hytale server"
  echo "  stop         - Stop Hytale server"
  echo "  update       - Update Hytale server"
  echo "  uninstall    - Uninstall Hytale server"
  echo "  status       - Show server status and configuration"
  echo "  console      - Attach to server console"
  echo "  logs         - View server logs (live tail)"
  echo "  backup       - Create manual backup"
  echo "  restore      - Restore from backup"
  echo "  autobackup   - Toggle automatic backups"
  echo "  autorestart  - Toggle automatic restarts"
  echo ""
  echo "Run without arguments to show this help."
}


# ================= COLORS =================
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m' # No Color
# =========================================


# ================= MAIN =================
# Parse command line arguments
if [ $# -eq 0 ]; then
  # No arguments, show interactive menu
  show_usage
else
  # Handle command line argument
  case "$1" in
    install)
      install_server
      ;;
    start)
      start_server
      ;;
    stop)
      stop_server
      ;;
    update)
      update_server
      ;;
    uninstall)
      uninstall_server
      ;;
    console)
      attach_console
      ;;
    backup)
      backup_server
      ;;
    restore)
      restore_server
      ;;
    autobackup)
      toggle_autobackup
      ;;
    autorestart)
      toggle_autorestart
      ;;
    status)
      show_status
      ;;
    logs)
      view_logs
      ;;
    help|--help|-h)
      show_usage
      ;;
    *)
      echo -e "${RED}Error: Unknown command '$1'${NC}"
      echo ""
      show_usage
      exit 1
      ;;
  esac
fi